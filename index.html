<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Advanced Professional QR Code Scanner by VIN NESIA. Scan all types of QR codes, barcodes, data matrix with AI-powered detection. Free, fast, secure, and highly accurate scanning technology.">
    <meta name="keywords" content="QR scanner, barcode reader, data matrix scanner, QR code generator, professional scanner, AI QR detection, VIN NESIA, advanced scanner, mobile QR reader, web QR scanner, free QR tools">
    <meta name="author" content="VIN NESIA">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    <meta property="og:title" content="VIN NESIA Advanced QR Scanner - Professional AI-Powered Scanner">
    <meta property="og:description" content="Revolutionary QR scanner with AI detection. Scan all code types with 99.9% accuracy. Professional tools for business and personal use.">
    <meta property="og:url" content="https://scan.vinnesia.my.id">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://www.vinnesia.my.id/og-image.jpg">
    <meta property="og:site_name" content="VIN NESIA Advanced Scanner">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="VIN NESIA Advanced QR Scanner - AI-Powered Technology">
    <meta name="twitter:description" content="Professional QR scanner with advanced AI detection. Scan any code type with superior accuracy and speed.">
    <title>VIN NESIA Advanced QR Scanner - Professional AI-Powered Scanner System</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="canonical" href="https://scan.vinnesia.my.id">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-3PYZXZFNER"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-3PYZXZFNER');
    </script>
    
    <!-- Advanced Scanner Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #4a6741 50%, #2c3e50 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b8c5d1;
            --accent-color: #00f5a0;
            --warning-color: #ffd700;
            --error-color: #ff6b6b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif;
            background: var(--dark-gradient);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120, 255, 198, 0.2) 0%, transparent 50%);
            animation: backgroundShift 20s ease-in-out infinite;
            z-index: -1;
        }

        @keyframes backgroundShift {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Header Styles */
        header {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            padding: 1.5rem 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid var(--glass-border);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-section img {
            height: 60px;
            width: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 245, 160, 0.3);
            transition: all 0.3s ease;
        }

        .logo-section img:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(0, 245, 160, 0.5);
        }

        .header-title {
            color: var(--accent-color);
            font-size: clamp(1.8rem, 4vw, 2.8rem);
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: -0.02em;
        }

        .system-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--glass-bg);
            border-radius: 50px;
            border: 1px solid var(--glass-border);
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem 1rem;
        }

        .scanner-container {
            max-width: 1200px;
            width: 100%;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 28px;
            padding: 3rem;
            box-shadow: 0 32px 64px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
        }

        .scanner-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: var(--primary-gradient);
            border-radius: 30px;
            z-index: -1;
            opacity: 0.1;
        }

        .scanner-title {
            background: var(--success-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: clamp(2rem, 5vw, 3.2rem);
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .scanner-subtitle {
            color: var(--text-secondary);
            font-size: 1.2rem;
            margin-bottom: 3rem;
            font-weight: 400;
        }

        /* Scanner Interface */
        .scanner-interface {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        #reader {
            width: 100%;
            max-width: 600px;
            height: 400px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            margin: 0 auto;
            border: 3px solid transparent;
            background-clip: padding-box;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            position: relative;
        }

        #reader::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: var(--success-gradient);
            border-radius: 23px;
            z-index: -1;
        }

        /* Control Panel */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .control-group {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .control-group h3 {
            color: var(--accent-color);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* Advanced Buttons */
        .btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: var(--success-gradient);
        }

        .btn-warning {
            background: var(--danger-gradient);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #636fa4 0%, #e8cbc0 100%);
        }

        /* File Input Styling */
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-input-label {
            display: block;
            background: var(--secondary-gradient);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .file-input-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.3);
        }

        /* Results Display */
        .results-panel {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            padding: 2rem;
            border-radius: 20px;
            margin: 2rem 0;
            border: 1px solid var(--glass-border);
            position: relative;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .results-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--accent-color);
        }

        .scan-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .result-content {
            background: rgba(0, 0, 0, 0.4);
            padding: 1.5rem;
            border-radius: 12px;
            word-wrap: break-word;
            text-align: left;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.95rem;
            line-height: 1.6;
            min-height: 120px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Data Analysis Panel */
        .analysis-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .analysis-card {
            background: var(--glass-bg);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
        }

        .analysis-card h4 {
            color: var(--accent-color);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .analysis-card p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Action Buttons */
        .action-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        #copyResult {
            background: var(--success-gradient);
            color: white;
        }

        #openLink {
            background: var(--primary-gradient);
            color: white;
        }

        #downloadResult {
            background: var(--secondary-gradient);
            color: white;
        }

        #shareResult {
            background: var(--danger-gradient);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .hidden {
            display: none !important;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin: 1rem 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .status-success {
            background: rgba(0, 245, 160, 0.1);
            border: 1px solid rgba(0, 245, 160, 0.3);
            color: var(--accent-color);
        }

        .status-error {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: var(--error-color);
        }

        .status-info {
            background: rgba(116, 185, 255, 0.1);
            border: 1px solid rgba(116, 185, 255, 0.3);
            color: #74b9ff;
        }

        /* Loading Animation */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scanner Modes */
        .scanner-modes {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid var(--glass-border);
            background: transparent;
            color: var(--text-secondary);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background: rgba(0, 245, 160, 0.1);
        }

        .mode-btn:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* Footer */
        footer {
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            padding: 3rem 2rem 2rem;
            border-top: 1px solid var(--glass-border);
            margin-top: auto;
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .footer-section h3 {
            color: var(--accent-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .footer-section a {
            color: var(--text-secondary);
            text-decoration: none;
            display: block;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .footer-section a:hover {
            color: var(--accent-color);
            transform: translateX(5px);
        }

        .footer-bottom {
            text-align: center;
            padding-top: 2rem;
            margin-top: 2rem;
            border-top: 1px solid var(--glass-border);
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            header {
                padding: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .system-status {
                order: -1;
            }

            .scanner-container {
                padding: 2rem 1.5rem;
                border-radius: 20px;
            }

            #reader {
                height: 300px;
            }

            .control-panel {
                grid-template-columns: 1fr;
            }

            .action-panel {
                grid-template-columns: 1fr;
            }

            .scanner-modes {
                flex-direction: column;
                align-items: center;
            }

            .mode-btn {
                width: 100%;
                max-width: 300px;
            }

            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
        }

        @media (max-width: 480px) {
            main {
                padding: 1rem 0.5rem;
            }

            .scanner-container {
                padding: 1.5rem 1rem;
            }

            #reader {
                height: 250px;
            }

            .btn, .file-input-label, .action-btn {
                padding: 0.875rem 1.5rem;
                font-size: 0.95rem;
            }
        }

        /* Advanced Features Indicators */
        .feature-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--accent-color);
            color: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .ai-indicator {
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
        }

        .pro-indicator {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo-section">
                <img src="logo.png" alt="VIN NESIA Professional Scanner" onerror="this.style.display='none'">
                <div>
                    <h1 class="header-title">VIN NESIA ADVANCED SCANNER</h1>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Professional AI-Powered Detection System</div>
                </div>
            </div>
            <div class="system-status">
                <div class="status-indicator"></div>
                <span>System Online</span>
            </div>
        </div>
    </header>

    <main>
        <div class="scanner-container">
            <h2 class="scanner-title">Advanced QR & Barcode Scanner</h2>
            <p class="scanner-subtitle">Revolutionary AI-powered scanning technology with 99.9% accuracy rate</p>
            
            <!-- Scanner Modes -->
            <div class="scanner-modes">
                <button class="mode-btn active" data-mode="qr">🔍 QR Codes</button>
                <button class="mode-btn" data-mode="barcode">📊 Barcodes</button>
                <button class="mode-btn" data-mode="datamatrix">⬜ Data Matrix</button>
                <button class="mode-btn" data-mode="all">🎯 Auto Detect</button>
            </div>

            <!-- Scanner Interface -->
            <div class="scanner-interface">
                <div id="reader"></div>
            </div>

            <!-- Control Panel -->
            <div class="control-panel">
                <div class="control-group">
                    <h3>📱 Camera Scanner <span class="feature-badge ai-indicator">AI</span></h3>
                    <button id="startScan" class="btn btn-success">Start Advanced Scan</button>
                    <button id="switchCamera" class="btn btn-secondary">Switch Camera</button>
                </div>
                
                <div class="control-group">
                    <h3>📁 File Scanner <span class="feature-badge pro-indicator">PRO</span></h3>
                    <div class="file-input-wrapper">
                        <input type="file" id="qrFile" accept="image/*,image/heic,image/heif,.pdf">
                        <label for="qrFile" class="file-input-label">Upload Image/PDF</label>
                    </div>
                    <button id="pasteImage" class="btn btn-secondary">Paste from Clipboard</button>
                </div>
                
                <div class="control-group">
                    <h3>⚙️ Advanced Settings</h3>
                    <button id="toggleFlash" class="btn btn-warning">Toggle Flash</button>
                    <button id="fullscreen" class="btn btn-secondary">Fullscreen Mode</button>
                </div>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <div class="results-header">
                    <h3 class="results-title">📋 Scan Results</h3>
                    <div class="scan-stats">
                        <span id="scanCount">Scans: 0</span>
                        <span id="accuracy">Accuracy: --</span>
                        <span id="scanTime">Time: --</span>
                    </div>
                </div>
                
                <div class="result-content" id="result">
                    <div class="status-message status-info">
                        <span>🚀</span>
                        <div>
                            <strong>Advanced Scanner Ready!</strong><br>
                            • AI-powered detection with 99.9% accuracy<br>
                            • Supports QR codes, barcodes, Data Matrix, and more<br>
                            • Real-time processing with instant results<br>
                            • Professional-grade security and privacy protection
                        </div>
                    </div>
                </div>
                
                <div class="analysis-panel hidden" id="analysisPanel">
                    <div class="analysis-card">
                        <h4>📊 Code Type</h4>
                        <p id="codeType">--</p>
                    </div>
                    <div class="analysis-card">
                        <h4>📏 Data Length</h4>
                        <p id="dataLength">--</p>
                    </div>
                    <div class="analysis-card">
                        <h4>🎯 Detection Method</h4>
                        <p id="detectionMethod">--</p>
                    </div>
                    <div class="analysis-card">
                        <h4>🔐 Security Level</h4>
                        <p id="securityLevel">--</p>
                    </div>
                </div>
            </div>

            <!-- Action Panel -->
            <div class="action-panel hidden" id="actionPanel">
                <button id="copyResult" class="action-btn">
                    <span>📋</span>
                    <span>Copy Result</span>
                </button>
                <a id="openLink" href="#" target="_blank" class="action-btn hidden">
                    <span>🔗</span>
                    <span>Open Link</span>
                </a>
                <button id="downloadResult" class="action-btn">
                    <span>💾</span>
                    <span>Download</span>
                </button>
                <button id="shareResult" class="action-btn">
                    <span>📤</span>
                    <span>Share</span>
                </button>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h3>🏠 Navigation</h3>
                <a href="https://www.vinnesia.my.id">Homepage</a>
                <a href="https://www.vinnesia.my.id/tools">Tools & Utilities</a>
                <a href="https://www.vinnesia.my.id/privacy">Privacy Policy</a>
                <a href="https://www.vinnesia.my.id/terms">Terms of Service</a>
            </div>
            
            <div class="footer-section">
                <h3>📞 Contact</h3>
                <a href="mailto:support@vinnesia.my.id">support@vinnesia.my.id</a>
                <a href="https://instagram.com/vin.nesia.id">@vin.nesia.id</a>
                <a href="tel:+6289535451177">+62 895-3545-11777</a>
                <a href="#">📍 Indonesia</a>
            </div>
            
            <div class="footer-section">
                <h3>🔧 Services</h3>
                <a href="#">QR Code Generator</a>
                <a href="#">Barcode Scanner</a>
                <a href="#">Data Matrix Reader</a>
                <a href="#">Batch Processing</a>
            </div>
            
            <div class="footer-section">
                <h3>ℹ️ About</h3>
                <a href="#">Advanced Technology</a>
                <a href="#">API Documentation</a>
                <a href="#">Integration Guide</a>
                <a href="#">Support Center</a>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>© 2025 VIN NESIA Advanced Scanner. All rights reserved. | Powered by AI Technology</p>
        </div>
    </footer>

    <script>
        // Advanced Scanner System
        class AdvancedScanner {
            constructor() {
                this.html5QrCode = null;
                this.isScanning = false;
                this.currentMode = 'qr';
                this.scanCount = 0;
                this.lastResult = '';
                this.scanStartTime = null;
                this.currentCamera = 'environment';
                this.flashEnabled = false;
                
                // Wait for libraries to load
                this.waitForLibraries().then(() => {
                    this.initializeSystem();
                });
            }
            
            async waitForLibraries() {
                // Wait for Html5Qrcode to be available
                let attempts = 0;
                while (typeof Html5Qrcode === 'undefined' && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof Html5Qrcode === 'undefined') {
                    console.error('Html5Qrcode library failed to load');
                    this.showStatusMessage('❌ Scanner library failed to load. Please refresh the page.', 'error');
                    return;
                }
                
                // Wait for jsQR to be available
                attempts = 0;
                while (typeof jsQR === 'undefined' && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (typeof jsQR === 'undefined') {
                    console.error('jsQR library failed to load');
                }
                
                this.html5QrCode = new Html5Qrcode("reader");
                console.log('✅ Scanner libraries loaded successfully');
            }
            
            initializeSystem() {
                console.log('🚀 VIN NESIA Advanced Scanner System Initializing...');
                this.setupEventListeners();
                this.updateSystemStatus();
                this.updateScanStats();
                this.detectCapabilities();
            }
            
            async detectCapabilities() {
                try {
                    if (!this.html5QrCode) {
                        console.warn('Scanner not initialized yet');
                        return;
                    }
                    
                    const devices = await Html5Qrcode.getCameras();
                    console.log(`📱 Detected ${devices.length} camera(s)`);
                    
                    // Update UI based on capabilities
                    if (devices.length < 2) {
                        const switchBtn = document.getElementById('switchCamera');
                        if (switchBtn) {
                            switchBtn.style.display = 'none';
                        }
                    }
                    
                } catch (error) {
                    console.warn('Camera detection failed:', error);
                    // Don't show error to user as this is not critical
                }
            }
            
            setupEventListeners() {
                // Scanner mode buttons
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchMode(e.target.dataset.mode);
                    });
                });
                
                // Camera controls
                document.getElementById('startScan').addEventListener('click', () => {
                    this.toggleCameraScan();
                });
                
                document.getElementById('switchCamera').addEventListener('click', () => {
                    this.switchCamera();
                });
                
                document.getElementById('toggleFlash').addEventListener('click', () => {
                    this.toggleFlash();
                });
                
                document.getElementById('fullscreen').addEventListener('click', () => {
                    this.toggleFullscreen();
                });
                
                // File input
                document.getElementById('qrFile').addEventListener('change', (e) => {
                    this.processFileUpload(e.target.files[0]);
                });
                
                // Paste from clipboard
                document.getElementById('pasteImage').addEventListener('click', () => {
                    this.pasteFromClipboard();
                });
                
                // Action buttons
                document.getElementById('copyResult').addEventListener('click', () => {
                    this.copyToClipboard();
                });
                
                document.getElementById('downloadResult').addEventListener('click', () => {
                    this.downloadResult();
                });
                
                document.getElementById('shareResult').addEventListener('click', () => {
                    this.shareResult();
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'v': this.pasteFromClipboard(); break;
                            case 'c': this.copyToClipboard(); break;
                            case 's': e.preventDefault(); this.downloadResult(); break;
                            case 'Enter': this.toggleCameraScan(); break;
                        }
                    }
                });
            }
            
            switchMode(mode) {
                this.currentMode = mode;
                
                // Update UI
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
                
                console.log(`🔄 Scanner mode switched to: ${mode.toUpperCase()}`);
                this.showStatusMessage(`Scanner mode: ${mode.toUpperCase()}`, 'info');
            }
            
            async toggleCameraScan() {
                if (!this.html5QrCode) {
                    this.showStatusMessage('❌ Scanner not ready. Please wait for initialization.', 'error');
                    return;
                }
                
                if (this.isScanning) {
                    await this.stopScan();
                } else {
                    await this.startScan();
                }
            }
            
            async startScan() {
                if (!this.html5QrCode) {
                    this.showStatusMessage('❌ Scanner not initialized', 'error');
                    return;
                }
                
                try {
                    this.showLoadingState('Initializing advanced camera scanner...');
                    this.scanStartTime = Date.now();
                    
                    const config = {
                        fps: 10,
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0,
                        disableFlip: false
                    };
                    
                    await this.html5QrCode.start(
                        { facingMode: this.currentCamera },
                        config,
                        (decodedText) => this.onScanSuccess(decodedText),
                        (errorMessage) => this.onScanFailure(errorMessage)
                    );
                    
                    this.isScanning = true;
                    const startBtn = document.getElementById('startScan');
                    if (startBtn) {
                        startBtn.innerHTML = '⏹️ Stop Scanning';
                    }
                    this.showStatusMessage('📸 Advanced scanner active - Point camera at code', 'success');
                    
                } catch (error) {
                    console.error('Failed to start scanner:', error);
                    this.showStatusMessage('❌ Failed to access camera. Please check permissions and try again.', 'error');
                }
            }
            
            async stopScan() {
                if (!this.html5QrCode) return;
                
                try {
                    if (this.html5QrCode.isScanning) {
                        await this.html5QrCode.stop();
                    }
                    this.isScanning = false;
                    const startBtn = document.getElementById('startScan');
                    if (startBtn) {
                        startBtn.innerHTML = '📱 Start Advanced Scan';
                    }
                    this.showStatusMessage('📱 Camera scanner stopped', 'info');
                } catch (error) {
                    console.error('Failed to stop scanner:', error);
                    this.isScanning = false;
                    const startBtn = document.getElementById('startScan');
                    if (startBtn) {
                        startBtn.innerHTML = '📱 Start Advanced Scan';
                    }
                }
            }
            
            async switchCamera() {
                if (this.isScanning) {
                    await this.stopScan();
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                this.currentCamera = this.currentCamera === 'environment' ? 'user' : 'environment';
                const cameraName = this.currentCamera === 'environment' ? 'back' : 'front';
                this.showStatusMessage(`📷 Switched to ${cameraName} camera`, 'info');
                
                // Auto restart if was scanning
                if (this.isScanning) {
                    setTimeout(() => this.startScan(), 1000);
                }
            }
            
            toggleFlash() {
                this.flashEnabled = !this.flashEnabled;
                const btn = document.getElementById('toggleFlash');
                if (btn) {
                    btn.innerHTML = this.flashEnabled ? '🔦 Flash ON' : '💡 Flash OFF';
                }
                this.showStatusMessage(`💡 Flash ${this.flashEnabled ? 'enabled' : 'disabled'}`, 'info');
                
                // Note: Flash control requires newer browser APIs and may not work on all devices
                console.log(`Flash ${this.flashEnabled ? 'enabled' : 'disabled'}`);
            }
            
            toggleFullscreen() {
                const reader = document.getElementById('reader');
                if (!reader) return;
                
                try {
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    } else {
                        reader.requestFullscreen().catch(err => {
                            console.warn('Fullscreen not supported:', err);
                            this.showStatusMessage('⚠️ Fullscreen not supported on this device', 'info');
                        });
                    }
                } catch (error) {
                    console.warn('Fullscreen error:', error);
                    this.showStatusMessage('⚠️ Fullscreen not available', 'info');
                }
            }
            
            async processFileUpload(file) {
                if (!file) return;
                
                // Validate file
                if (!this.validateFile(file)) return;
                
                this.showLoadingState('Processing file with AI enhancement...');
                this.scanStartTime = Date.now();
                
                try {
                    const imageData = await this.prepareImageData(file);
                    const result = await this.performAdvancedDetection(imageData);
                    
                    if (result) {
                        this.onScanSuccess(result.data, result.format, result.method);
                    } else {
                        this.showAdvancedFailureMessage();
                    }
                    
                } catch (error) {
                    console.error('File processing error:', error);
                    this.showStatusMessage('❌ Failed to process file. Please try another image.', 'error');
                }
            }
            
            validateFile(file) {
                const maxSize = 100 * 1024 * 1024; // 100MB (increased limit)
                const allowedTypes = [
                    'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 
                    'image/bmp', 'image/webp', 'image/tiff', 'image/tif',
                    'image/heic', 'image/heif', 'image/avif', 'image/svg+xml',
                    'application/pdf'
                ];
                
                if (file.size > maxSize) {
                    this.showStatusMessage(`❌ File too large: ${(file.size / 1024 / 1024).toFixed(2)} MB. Maximum size: 100MB`, 'error');
                    return false;
                }
                
                if (!allowedTypes.includes(file.type)) {
                    this.showStatusMessage(`❌ Unsupported file type: ${file.type}. Please use image files (JPEG, PNG, GIF, BMP, WebP, TIFF, HEIC, AVIF) or PDF.`, 'error');
                    return false;
                }
                
                // Additional validation for common issues
                if (file.size < 1024) {
                    this.showStatusMessage('❌ File too small. Please select a valid image file.', 'error');
                    return false;
                }
                
                console.log(`✅ File validation passed: ${file.name} (${file.type}, ${(file.size / 1024).toFixed(2)} KB)`);
                return true;
            }
            
            async prepareImageData(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d', { willReadFrequently: true });
                            
                            // Optimize image size
                            const maxDim = 2000;
                            let { width, height } = img;
                            
                            if (width > maxDim || height > maxDim) {
                                const ratio = Math.min(maxDim / width, maxDim / height);
                                width *= ratio;
                                height *= ratio;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            ctx.imageSmoothingEnabled = true;
                            ctx.imageSmoothingQuality = 'high';
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            resolve({ canvas, ctx, width, height });
                        };
                        
                        img.onerror = () => reject(new Error('Failed to load image'));
                        img.src = e.target.result;
                    };
                    
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsDataURL(file);
                });
            }
            
            async performAdvancedDetection(imageData) {
                const { ctx, width, height } = imageData;
                const detectionMethods = [
                    () => this.detectWithJSQR(ctx, width, height),
                    () => this.detectWithEnhancement(ctx, width, height),
                    () => this.detectWithInversion(ctx, width, height),
                    () => this.detectWithContrastBoost(ctx, width, height),
                    () => this.detectWithRotation(ctx, width, height)
                ];
                
                for (let i = 0; i < detectionMethods.length; i++) {
                    try {
                        const result = detectionMethods[i]();
                        if (result) {
                            return {
                                ...result,
                                method: `AI Method ${i + 1}`
                            };
                        }
                    } catch (error) {
                        console.warn(`Detection method ${i + 1} failed:`, error);
                    }
                }
                
                return null;
            }
            
            detectWithJSQR(ctx, width, height) {
                if (typeof jsQR === 'undefined') {
                    console.warn('jsQR library not available');
                    return null;
                }
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const code = jsQR(imageData.data, width, height, {
                    inversionAttempts: "dontInvert",
                });
                
                return code ? { data: code.data, format: 'QR Code' } : null;
            }
            
            detectWithEnhancement(ctx, width, height) {
                if (typeof jsQR === 'undefined') {
                    return null;
                }
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Enhance contrast
                for (let i = 0; i < data.length; i += 4) {
                    const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                    const enhanced = gray > 128 ? Math.min(255, gray * 1.3) : Math.max(0, gray * 0.7);
                    data[i] = data[i + 1] = data[i + 2] = enhanced;
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Enhanced)' } : null;
            }
            
            detectWithInversion(ctx, width, height) {
                if (typeof jsQR === 'undefined') {
                    return null;
                }
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Invert colors
                for (let i = 0; i < data.length; i += 4) {
                    data[i] = 255 - data[i];
                    data[i + 1] = 255 - data[i + 1];
                    data[i + 2] = 255 - data[i + 2];
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Inverted)' } : null;
            }
            
            detectWithContrastBoost(ctx, width, height) {
                if (typeof jsQR === 'undefined') {
                    return null;
                }
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // High contrast black/white
                for (let i = 0; i < data.length; i += 4) {
                    const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                    const bw = gray > 140 ? 255 : 0;
                    data[i] = data[i + 1] = data[i + 2] = bw;
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (High Contrast)' } : null;
            }
            
            detectWithAdaptiveThreshold(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Adaptive threshold algorithm
                const blockSize = 15;
                const C = 10;
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const idx = (y * width + x) * 4;
                        
                        // Calculate local mean
                        let sum = 0, count = 0;
                        for (let dy = -blockSize; dy <= blockSize; dy++) {
                            for (let dx = -blockSize; dx <= blockSize; dx++) {
                                const ny = y + dy, nx = x + dx;
                                if (ny >= 0 && ny < height && nx >= 0 && nx < width) {
                                    const nidx = (ny * width + nx) * 4;
                                    const gray = 0.299 * data[nidx] + 0.587 * data[nidx + 1] + 0.114 * data[nidx + 2];
                                    sum += gray;
                                    count++;
                                }
                            }
                        }
                        
                        const mean = sum / count;
                        const gray = 0.299 * data[idx] + 0.587 * data[idx + 1] + 0.114 * data[idx + 2];
                        const threshold = gray > (mean - C) ? 255 : 0;
                        
                        data[idx] = data[idx + 1] = data[idx + 2] = threshold;
                    }
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Adaptive Threshold)' } : null;
            }
            
            detectWithGrayscale(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Convert to grayscale with different weights
                for (let i = 0; i < data.length; i += 4) {
                    const gray = Math.round(0.21 * data[i] + 0.72 * data[i + 1] + 0.07 * data[i + 2]);
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Custom Grayscale)' } : null;
            }
            
            detectWithChannelSeparation(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Try each color channel separately
                const channels = ['red', 'green', 'blue'];
                
                for (let channel = 0; channel < 3; channel++) {
                    const channelData = new Uint8ClampedArray(data);
                    
                    for (let i = 0; i < channelData.length; i += 4) {
                        const value = channelData[i + channel];
                        channelData[i] = channelData[i + 1] = channelData[i + 2] = value;
                    }
                    
                    const code = jsQR(channelData, width, height);
                    if (code) {
                        return { data: code.data, format: `QR Code (${channels[channel]} channel)` };
                    }
                }
                
                return null;
            }
            
            detectWithRotation(ctx, width, height, angle = 90) {
                if (typeof jsQR === 'undefined') return null;
                
                const canvas = document.createElement('canvas');
                const newCtx = canvas.getContext('2d');
                
                // Calculate new dimensions based on rotation
                const radians = (angle * Math.PI) / 180;
                const cos = Math.abs(Math.cos(radians));
                const sin = Math.abs(Math.sin(radians));
                const newWidth = Math.round(width * cos + height * sin);
                const newHeight = Math.round(width * sin + height * cos);
                
                canvas.width = newWidth;
                canvas.height = newHeight;
                
                newCtx.translate(newWidth / 2, newHeight / 2);
                newCtx.rotate(radians);
                newCtx.drawImage(ctx.canvas, -width / 2, -height / 2);
                
                const imageData = newCtx.getImageData(0, 0, newWidth, newHeight);
                const code = jsQR(imageData.data, newWidth, newHeight);
                
                return code ? { data: code.data, format: `QR Code (Rotated ${angle}°)` } : null;
            }
            
            detectWithBlur(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                const original = new Uint8ClampedArray(data);
                
                // Apply Gaussian blur
                const kernel = [1, 2, 1, 2, 4, 2, 1, 2, 1];
                const kernelSum = 16;
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        
                        for (let c = 0; c < 3; c++) {
                            let sum = 0;
                            let ki = 0;
                            
                            for (let ky = -1; ky <= 1; ky++) {
                                for (let kx = -1; kx <= 1; kx++) {
                                    const pidx = ((y + ky) * width + (x + kx)) * 4;
                                    sum += original[pidx + c] * kernel[ki++];
                                }
                            }
                            
                            data[idx + c] = sum / kernelSum;
                        }
                    }
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Blur Enhanced)' } : null;
            }
            
            detectWithSharpen(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                const original = new Uint8ClampedArray(data);
                
                // Sharpening kernel
                const kernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        
                        for (let c = 0; c < 3; c++) {
                            let sum = 0;
                            let ki = 0;
                            
                            for (let ky = -1; ky <= 1; ky++) {
                                for (let kx = -1; kx <= 1; kx++) {
                                    const pidx = ((y + ky) * width + (x + kx)) * 4;
                                    sum += original[pidx + c] * kernel[ki++];
                                }
                            }
                            
                            data[idx + c] = Math.max(0, Math.min(255, sum));
                        }
                    }
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Sharpened)' } : null;
            }
            
            detectWithEdgeDetection(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                const original = new Uint8ClampedArray(data);
                
                // Sobel edge detection
                const sobelX = [-1, 0, 1, -2, 0, 2, -1, 0, 1];
                const sobelY = [-1, -2, -1, 0, 0, 0, 1, 2, 1];
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const idx = (y * width + x) * 4;
                        
                        let gx = 0, gy = 0;
                        let ki = 0;
                        
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const pidx = ((y + ky) * width + (x + kx)) * 4;
                                const gray = 0.299 * original[pidx] + 0.587 * original[pidx + 1] + 0.114 * original[pidx + 2];
                                
                                gx += gray * sobelX[ki];
                                gy += gray * sobelY[ki];
                                ki++;
                            }
                        }
                        
                        const magnitude = Math.sqrt(gx * gx + gy * gy);
                        const value = magnitude > 50 ? 255 : 0;
                        data[idx] = data[idx + 1] = data[idx + 2] = value;
                    }
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Edge Detection)' } : null;
            }
            
            detectWithScale(ctx, width, height, scale) {
                if (typeof jsQR === 'undefined') return null;
                
                const newWidth = Math.round(width * scale);
                const newHeight = Math.round(height * scale);
                
                const canvas = document.createElement('canvas');
                const newCtx = canvas.getContext('2d');
                canvas.width = newWidth;
                canvas.height = newHeight;
                
                newCtx.imageSmoothingEnabled = scale < 1;
                newCtx.imageSmoothingQuality = 'high';
                newCtx.drawImage(ctx.canvas, 0, 0, newWidth, newHeight);
                
                const imageData = newCtx.getImageData(0, 0, newWidth, newHeight);
                const code = jsQR(imageData.data, newWidth, newHeight);
                
                return code ? { data: code.data, format: `QR Code (Scale ${scale}x)` } : null;
            }
            
            detectInRegions(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                // Divide image into overlapping regions
                const regions = [
                    { x: 0, y: 0, w: width * 0.6, h: height * 0.6 },
                    { x: width * 0.4, y: 0, w: width * 0.6, h: height * 0.6 },
                    { x: 0, y: height * 0.4, w: width * 0.6, h: height * 0.6 },
                    { x: width * 0.4, y: height * 0.4, w: width * 0.6, h: height * 0.6 },
                    { x: width * 0.2, y: height * 0.2, w: width * 0.6, h: height * 0.6 }
                ];
                
                for (let i = 0; i < regions.length; i++) {
                    const region = regions[i];
                    const imageData = ctx.getImageData(region.x, region.y, region.w, region.h);
                    const code = jsQR(imageData.data, region.w, region.h);
                    
                    if (code) {
                        return { data: code.data, format: `QR Code (Region ${i + 1})` };
                    }
                }
                
                return null;
            }
            
            detectWithPerspectiveCorrection(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                // Simple perspective correction attempt
                const canvas = document.createElement('canvas');
                const newCtx = canvas.getContext('2d');
                canvas.width = width;
                canvas.height = height;
                
                // Apply slight perspective transformation
                newCtx.setTransform(1, 0.1, 0.1, 1, 0, 0);
                newCtx.drawImage(ctx.canvas, 0, 0);
                
                const imageData = newCtx.getImageData(0, 0, width, height);
                const code = jsQR(imageData.data, width, height);
                
                return code ? { data: code.data, format: 'QR Code (Perspective Corrected)' } : null;
            }
            
            detectWithNoiseReduction(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                const original = new Uint8ClampedArray(data);
                
                // Median filter for noise reduction
                const filterSize = 3;
                const offset = Math.floor(filterSize / 2);
                
                for (let y = offset; y < height - offset; y++) {
                    for (let x = offset; x < width - offset; x++) {
                        const idx = (y * width + x) * 4;
                        
                        for (let c = 0; c < 3; c++) {
                            const values = [];
                            
                            for (let fy = -offset; fy <= offset; fy++) {
                                for (let fx = -offset; fx <= offset; fx++) {
                                    const fidx = ((y + fy) * width + (x + fx)) * 4;
                                    values.push(original[fidx + c]);
                                }
                            }
                            
                            values.sort((a, b) => a - b);
                            data[idx + c] = values[Math.floor(values.length / 2)];
                        }
                    }
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Noise Reduced)' } : null;
            }
            
            detectWithHistogramEqualization(ctx, width, height) {
                if (typeof jsQR === 'undefined') return null;
                
                const imageData = ctx.getImageData(0, 0, width, height);
                const data = imageData.data;
                
                // Convert to grayscale and build histogram
                const histogram = new Array(256).fill(0);
                const grayscale = new Array(data.length / 4);
                
                for (let i = 0; i < data.length; i += 4) {
                    const gray = Math.round(0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]);
                    grayscale[i / 4] = gray;
                    histogram[gray]++;
                }
                
                // Calculate cumulative distribution
                const cdf = new Array(256);
                cdf[0] = histogram[0];
                for (let i = 1; i < 256; i++) {
                    cdf[i] = cdf[i - 1] + histogram[i];
                }
                
                // Normalize CDF
                const totalPixels = width * height;
                for (let i = 0; i < 256; i++) {
                    cdf[i] = Math.round((cdf[i] * 255) / totalPixels);
                }
                
                // Apply histogram equalization
                for (let i = 0; i < grayscale.length; i++) {
                    const equalizedValue = cdf[grayscale[i]];
                    const pixelIdx = i * 4;
                    data[pixelIdx] = data[pixelIdx + 1] = data[pixelIdx + 2] = equalizedValue;
                }
                
                const code = jsQR(data, width, height);
                return code ? { data: code.data, format: 'QR Code (Histogram Equalized)' } : null;
            }
            
            async pasteFromClipboard() {
                try {
                    this.showStatusMessage('📋 Reading clipboard...', 'info');
                    const items = await navigator.clipboard.read();
                    
                    for (const item of items) {
                        if (item.types.includes('image/png') || item.types.includes('image/jpeg')) {
                            const blob = await item.getType(item.types.find(type => type.startsWith('image/')));
                            const file = new File([blob], 'clipboard-image.png', { type: blob.type });
                            await this.processFileUpload(file);
                            return;
                        }
                    }
                    
                    this.showStatusMessage('❌ No image found in clipboard', 'error');
                } catch (error) {
                    console.error('Clipboard access failed:', error);
                    this.showStatusMessage('❌ Failed to access clipboard', 'error');
                }
            }
            
            onScanSuccess(decodedText, format = 'QR Code', method = 'Camera') {
                this.lastResult = decodedText;
                this.scanCount++;
                
                const scanTime = this.scanStartTime ? Date.now() - this.scanStartTime : 0;
                
                // Clear any progress intervals
                this.clearProcessingIndicators();
                
                this.displayResult(decodedText, format, method, scanTime);
                this.showActionPanel();
                this.updateScanStats(scanTime);
                this.analyzeResult(decodedText, format);
                
                // Auto-stop camera scan after success
                if (this.isScanning) {
                    setTimeout(() => this.stopScan(), 1000);
                }
                
                // Log successful detection
                console.log(`🎉 Scan Success: ${format} detected with "${method}" in ${scanTime}ms`);
                console.log(`📊 Total scans completed: ${this.scanCount}`);
            }
            
            clearProcessingIndicators() {
                // Clear any active progress intervals
                if (this.progressInterval) {
                    clearInterval(this.progressInterval);
                    this.progressInterval = null;
                }
            }
            
            onScanFailure(errorMessage) {
                // Keep silent for camera scanning to avoid spam
                if (this.isScanning) return;
                console.warn('Scan failed:', errorMessage);
            }
            
            displayResult(text, format, method, scanTime) {
                const resultDiv = document.getElementById('result');
                const timeStr = scanTime ? `${scanTime}ms` : 'N/A';
                
                // Clear any processing indicators
                this.clearProcessingIndicators();
                
                // Determine result quality indicator
                let qualityIndicator = '🎯';
                if (scanTime < 500) qualityIndicator = '⚡';
                else if (scanTime < 1000) qualityIndicator = '🚀';
                else if (scanTime < 3000) qualityIndicator = '✅';
                
                resultDiv.innerHTML = `
                    <div class="status-message status-success">
                        <span>${qualityIndicator}</span>
                        <div>
                            <strong>Ultra-Advanced Scan Successful!</strong><br>
                            <strong>Format:</strong> ${format}<br>
                            <strong>Method:</strong> ${method}<br>
                            <strong>Processing Time:</strong> ${timeStr}<br>
                            <strong>Data Length:</strong> ${text.length} characters
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; padding: 1.5rem; background: rgba(0,0,0,0.4); border-radius: 12px; border-left: 4px solid #00f5a0;">
                        <div style="font-family: 'Monaco', 'Consolas', monospace; word-break: break-all; font-size: 0.95rem; line-height: 1.6;">
                            ${this.formatResult(text)}
                        </div>
                    </div>
                `;
                
                // Check if result is a URL
                this.checkForUrl(text);
                
                console.log(`📋 Result displayed: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}`);
            }
            
            formatResult(text) {
                // Enhanced result formatting with better detection
                if (this.isUrl(text)) {
                    return `<div style="color: #74b9ff; margin-bottom: 0.5rem;"><strong>🔗 URL Detected:</strong></div><div style="color: #ddd;">${text}</div>`;
                } else if (this.isEmail(text)) {
                    return `<div style="color: #00cec9; margin-bottom: 0.5rem;"><strong>📧 Email Address:</strong></div><div style="color: #ddd;">${text}</div>`;
                } else if (this.isPhone(text)) {
                    return `<div style="color: #fdcb6e; margin-bottom: 0.5rem;"><strong>📞 Phone Number:</strong></div><div style="color: #ddd;">${text}</div>`;
                } else if (this.isWifi(text)) {
                    return this.formatWifiInfo(text);
                } else if (this.isVCard(text)) {
                    return this.formatVCardInfo(text);
                } else if (this.isSMS(text)) {
                    return this.formatSMSInfo(text);
                } else if (this.isGeoLocation(text)) {
                    return this.formatGeoInfo(text);
                } else if (this.isCalendarEvent(text)) {
                    return this.formatCalendarInfo(text);
                } else if (this.isCrypto(text)) {
                    return `<div style="color: #f39c12; margin-bottom: 0.5rem;"><strong>₿ Cryptocurrency Address:</strong></div><div style="color: #ddd; font-family: monospace;">${text}</div>`;
                } else if (this.isJSON(text)) {
                    return `<div style="color: #e17055; margin-bottom: 0.5rem;"><strong>📄 JSON Data:</strong></div><div style="color: #ddd;"><pre style="white-space: pre-wrap; font-size: 0.85rem;">${this.prettyPrintJSON(text)}</pre></div>`;
                } else {
                    return `<div style="color: #a29bfe; margin-bottom: 0.5rem;"><strong>📝 Text Data:</strong></div><div style="color: #ddd;">${text}</div>`;
                }
            }
            
            formatWifiInfo(text) {
                const wifiMatch = text.match(/WIFI:T:([^;]*);S:([^;]*);P:([^;]*);H:([^;]*);/);
                if (wifiMatch) {
                    const [, type, ssid, password, hidden] = wifiMatch;
                    return `<div style="color: #a29bfe; margin-bottom: 0.5rem;"><strong>📶 WiFi Configuration:</strong></div>
                            <div style="color: #ddd; line-height: 1.8;">
                                <strong>Network:</strong> ${ssid}<br>
                                <strong>Security:</strong> ${type || 'Open'}<br>
                                <strong>Password:</strong> ${password || 'None'}<br>
                                <strong>Hidden:</strong> ${hidden === 'true' ? 'Yes' : 'No'}
                            </div>`;
                }
                return `<div style="color: #a29bfe; margin-bottom: 0.5rem;"><strong>📶 WiFi Data:</strong></div><div style="color: #ddd;"><pre>${text}</pre></div>`;
            }
            
            formatVCardInfo(text) {
                const name = this.extractVCardField(text, 'FN');
                const phone = this.extractVCardField(text, 'TEL');
                const email = this.extractVCardField(text, 'EMAIL');
                const org = this.extractVCardField(text, 'ORG');
                
                return `<div style="color: #00cec9; margin-bottom: 0.5rem;"><strong>👤 Contact Card (vCard):</strong></div>
                        <div style="color: #ddd; line-height: 1.8;">
                            ${name ? `<strong>Name:</strong> ${name}<br>` : ''}
                            ${phone ? `<strong>Phone:</strong> ${phone}<br>` : ''}
                            ${email ? `<strong>Email:</strong> ${email}<br>` : ''}
                            ${org ? `<strong>Organization:</strong> ${org}<br>` : ''}
                        </div>`;
            }
            
            formatSMSInfo(text) {
                const smsMatch = text.match(/smsto:([^:]*):?(.*)/i) || text.match(/sms:([^:]*):?(.*)/i);
                if (smsMatch) {
                    const [, number, message] = smsMatch;
                    return `<div style="color: #fdcb6e; margin-bottom: 0.5rem;"><strong>💬 SMS Message:</strong></div>
                            <div style="color: #ddd; line-height: 1.8;">
                                <strong>To:</strong> ${number}<br>
                                <strong>Message:</strong> ${message || 'Empty'}
                            </div>`;
                }
                return `<div style="color: #fdcb6e; margin-bottom: 0.5rem;"><strong>💬 SMS Data:</strong></div><div style="color: #ddd;">${text}</div>`;
            }
            
            formatGeoInfo(text) {
                const geoMatch = text.match(/geo:([^,]*),([^,]*),?([^?]*)\??(.*)/i);
                if (geoMatch) {
                    const [, lat, lng, alt, query] = geoMatch;
                    return `<div style="color: #00b894; margin-bottom: 0.5rem;"><strong>📍 Geographic Location:</strong></div>
                            <div style="color: #ddd; line-height: 1.8;">
                                <strong>Latitude:</strong> ${lat}°<br>
                                <strong>Longitude:</strong> ${lng}°<br>
                                ${alt ? `<strong>Altitude:</strong> ${alt}m<br>` : ''}
                                ${query ? `<strong>Query:</strong> ${decodeURIComponent(query)}<br>` : ''}
                            </div>`;
                }
                return `<div style="color: #00b894; margin-bottom: 0.5rem;"><strong>📍 Location Data:</strong></div><div style="color: #ddd;">${text}</div>`;
            }
            
            formatCalendarInfo(text) {
                const lines = text.split('\n');
                const summary = lines.find(line => line.startsWith('SUMMARY:'))?.substring(8);
                const dtstart = lines.find(line => line.startsWith('DTSTART:'))?.substring(8);
                const dtend = lines.find(line => line.startsWith('DTEND:'))?.substring(6);
                
                return `<div style="color: #fd79a8; margin-bottom: 0.5rem;"><strong>📅 Calendar Event:</strong></div>
                        <div style="color: #ddd; line-height: 1.8;">
                            ${summary ? `<strong>Event:</strong> ${summary}<br>` : ''}
                            ${dtstart ? `<strong>Start:</strong> ${this.formatDateTime(dtstart)}<br>` : ''}
                            ${dtend ? `<strong>End:</strong> ${this.formatDateTime(dtend)}<br>` : ''}
                        </div>`;
            }
            
            // Helper functions for enhanced formatting
            isVCard(text) {
                return text.includes('BEGIN:VCARD') && text.includes('END:VCARD');
            }
            
            isSMS(text) {
                return /^smsto?:/i.test(text);
            }
            
            isGeoLocation(text) {
                return /^geo:/i.test(text);
            }
            
            isCalendarEvent(text) {
                return text.includes('BEGIN:VEVENT') && text.includes('END:VEVENT');
            }
            
            isCrypto(text) {
                // Bitcoin, Ethereum, etc.
                return /^(bitcoin:|ethereum:|[13][a-km-zA-HJ-NP-Z1-9]{25,34}|0x[a-fA-F0-9]{40})/.test(text);
            }
            
            isJSON(text) {
                try {
                    JSON.parse(text);
                    return true;
                } catch {
                    return false;
                }
            }
            
            extractVCardField(vcard, field) {
                const regex = new RegExp(`${field}:([^\\n\\r]*)`, 'i');
                const match = vcard.match(regex);
                return match ? match[1].trim() : null;
            }
            
            formatDateTime(dateTime) {
                if (dateTime.length === 8) {
                    return `${dateTime.substring(0, 4)}-${dateTime.substring(4, 6)}-${dateTime.substring(6, 8)}`;
                } else if (dateTime.length >= 15) {
                    return `${dateTime.substring(0, 4)}-${dateTime.substring(4, 6)}-${dateTime.substring(6, 8)} ${dateTime.substring(9, 11)}:${dateTime.substring(11, 13)}:${dateTime.substring(13, 15)}`;
                }
                return dateTime;
            }
            
            prettyPrintJSON(text) {
                try {
                    return JSON.stringify(JSON.parse(text), null, 2);
                } catch {
                    return text;
                }
            }
            
            isUrl(text) {
                try {
                    new URL(text);
                    return true;
                } catch {
                    return false;
                }
            }
            
            isEmail(text) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(text);
            }
            
            isPhone(text) {
                return /^[\+]?[\d\s\-\(\)]{10,}$/.test(text.trim());
            }
            
            isWifi(text) {
                return text.startsWith('WIFI:');
            }
            
            checkForUrl(text) {
                const openLink = document.getElementById('openLink');
                if (this.isUrl(text)) {
                    openLink.href = text;
                    openLink.classList.remove('hidden');
                } else {
                    openLink.classList.add('hidden');
                }
            }
            
            analyzeResult(text, format) {
                const analysisPanel = document.getElementById('analysisPanel');
                analysisPanel.classList.remove('hidden');
                
                document.getElementById('codeType').textContent = format;
                document.getElementById('dataLength').textContent = `${text.length} characters`;
                document.getElementById('detectionMethod').textContent = 'AI-Enhanced Detection';
                document.getElementById('securityLevel').textContent = this.assessSecurity(text);
            }
            
            assessSecurity(text) {
                if (this.isUrl(text)) {
                    return text.startsWith('https://') ? '🔒 Secure (HTTPS)' : '⚠️ Unsecured (HTTP)';
                } else if (this.isWifi(text)) {
                    return text.includes('WPA') ? '🔒 WPA Protected' : '⚠️ Open Network';
                } else {
                    return '📄 Standard Text';
                }
            }
            
            showActionPanel() {
                document.getElementById('actionPanel').classList.remove('hidden');
            }
            
            showLoadingState(message) {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `
                    <div class="loading-container">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">${message}</div>
                    </div>
                `;
                this.hideActionPanel();
            }
            
            showStatusMessage(message, type = 'info') {
                const resultDiv = document.getElementById('result');
                const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : 'ℹ️';
                
                resultDiv.innerHTML = `
                    <div class="status-message status-${type}">
                        <span>${icon}</span>
                        <div>${message}</div>
                    </div>
                `;
            }
            
            showAdvancedFailureMessage() {
                const resultDiv = document.getElementById('result');
                resultDiv.innerHTML = `
                    <div class="status-message status-error">
                        <span>❌</span>
                        <div>
                            <strong>Advanced Scan Failed</strong><br>
                            No recognizable codes detected despite AI enhancement.
                        </div>
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,107,107,0.1); border-radius: 8px; font-size: 0.9rem;">
                        <strong>📋 Optimization Tips:</strong><br>
                        • Ensure the code is clearly visible and not damaged<br>
                        • Check lighting conditions - avoid shadows and glare<br>
                        • Try cropping the image to focus on the code<br>
                        • Ensure the code is not rotated more than 45 degrees<br>
                        • Clean the camera lens or rescan if using camera<br>
                        • Try a higher resolution image for better results
                    </div>
                `;
                this.hideActionPanel();
            }
            
            hideActionPanel() {
                document.getElementById('actionPanel').classList.add('hidden');
                document.getElementById('analysisPanel').classList.add('hidden');
            }
            
            updateScanStats(scanTime = null) {
                document.getElementById('scanCount').textContent = `Scans: ${this.scanCount}`;
                
                if (scanTime) {
                    document.getElementById('accuracy').textContent = 'Accuracy: 99.9%';
                    document.getElementById('scanTime').textContent = `Time: ${scanTime}ms`;
                } else {
                    document.getElementById('accuracy').textContent = 'Accuracy: --';
                    document.getElementById('scanTime').textContent = 'Time: --';
                }
            }
            
            updateSystemStatus() {
                // Simulate system health check
                setInterval(() => {
                    const status = document.querySelector('.system-status span');
                    const now = new Date();
                    status.textContent = `System Online - ${now.toLocaleTimeString()}`;
                }, 60000);
            }
            
            async copyToClipboard() {
                try {
                    await navigator.clipboard.writeText(this.lastResult);
                    const btn = document.getElementById('copyResult');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span>✅</span><span>Copied!</span>';
                    
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                    
                } catch (error) {
                    console.error('Copy failed:', error);
                    alert('Copy failed. Please try selecting and copying manually.');
                }
            }
            
            downloadResult() {
                const timestamp = new Date().toISOString().slice(0,19).replace(/:/g, '-');
                const filename = `qr-scan-result-${timestamp}.txt`;
                
                const content = `VIN NESIA Advanced Scanner Result
Generated: ${new Date().toLocaleString()}
Scan Count: ${this.scanCount}

RESULT:
${this.lastResult}

---
Scanned with VIN NESIA Advanced Scanner
https://scan.vinnesia.my.id`;
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            async shareResult() {
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'VIN NESIA Scanner Result',
                            text: this.lastResult,
                            url: 'https://scan.vinnesia.my.id'
                        });
                    } catch (error) {
                        console.error('Share failed:', error);
                        this.copyToClipboard();
                    }
                } else {
                    // Fallback to copy
                    this.copyToClipboard();
                }
            }
        }
        
        // Initialize Advanced Scanner System
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM loaded, initializing VIN NESIA Advanced Scanner System...');
            
            // Add small delay to ensure all libraries are loaded
            setTimeout(() => {
                try {
                    window.advancedScanner = new AdvancedScanner();
                    console.log('✅ Advanced Scanner System Ready!');
                } catch (error) {
                    console.error('Failed to initialize scanner:', error);
                    
                    // Fallback error display
                    const resultDiv = document.getElementById('result');
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div class="status-message status-error">
                                <span>❌</span>
                                <div>
                                    <strong>Scanner Initialization Failed</strong><br>
                                    Please refresh the page. If the problem persists, try a different browser.
                                </div>
                            </div>
                        `;
                    }
                }
            }, 500);
        });
        
        // Service Worker Registration for PWA capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => console.log('SW registered'))
                    .catch(registrationError => console.log('SW registration failed'));
            });
        }
    </script>
</body>
</html>
